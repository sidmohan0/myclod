use tauri_specta::{collect_commands, Builder};

pub fn generate_bindings() -> Builder<tauri::Wry> {
    use crate::commands::{auth, deps, notifications, preferences, pty, quick_pane, recovery};

    Builder::<tauri::Wry>::new().commands(collect_commands![
        // Preferences
        preferences::greet,
        preferences::load_preferences,
        preferences::save_preferences,
        // Notifications
        notifications::send_native_notification,
        // Recovery
        recovery::save_emergency_data,
        recovery::load_emergency_data,
        recovery::cleanup_old_recovery_files,
        // Quick pane
        quick_pane::show_quick_pane,
        quick_pane::dismiss_quick_pane,
        quick_pane::toggle_quick_pane,
        quick_pane::get_default_quick_pane_shortcut,
        quick_pane::update_quick_pane_shortcut,
        // Dependencies
        deps::check_dependencies,
        deps::install_claude_code,
        // PTY
        pty::spawn_claude,
        pty::send_input,
        pty::resize_terminal,
        pty::kill_session,
        pty::has_active_session,
        // Auth
        auth::check_auth_status,
        auth::get_claude_config_info,
    ])
}

/// Export TypeScript bindings to the frontend.
/// Run with: cargo test export_bindings -- --ignored
pub fn export_ts_bindings() {
    generate_bindings()
        .export(
            specta_typescript::Typescript::default()
                .header("// @ts-nocheck\n// Auto-generated by tauri-specta. DO NOT EDIT.\n\n"),
            "../src/lib/bindings.ts",
        )
        .expect("Failed to export TypeScript bindings");
}

#[cfg(test)]
mod tests {
    use super::*;

    /// Generate TypeScript bindings file.
    /// This test is ignored by default so it doesn't run in CI.
    /// Run manually with: cargo test export_bindings -- --ignored
    #[test]
    #[ignore]
    fn export_bindings() {
        export_ts_bindings();
        println!("âœ“ TypeScript bindings exported to ../src/lib/bindings.ts");
    }
}
